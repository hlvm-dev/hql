# üì¶ HQL Distribution Guide

## üéØ Goal
Make HQL available as a standalone binary: `hql run hello.hql`

---

## ‚úÖ WHAT WORKS NOW

### 1. Binary Compilation
```bash
cd /Users/seoksoonjang/Desktop/hlvm/src/hql
make build
```

**Result:** Creates 80MB `hql` binary with everything embedded ‚úÖ

### 2. Version Check
```bash
./hql --version
# Output: HQL CLI version 0.1.0
```
**Status:** ‚úÖ WORKS

---

## ‚ùå WHAT DOESN'T WORK YET

### 1. Running HQL Files
```bash
./hql run test.hql
```
**Error:**
- ‚ö†Ô∏è Can't find `stdlib.hql`
- ‚ö†Ô∏è esbuild bundler issues

### 2. Running HQL Expressions
```bash
./hql run '(+ 1 2)'
```
**Error:** Treats expression as filename

---

## üîß HOW HLVM SOLVED THIS (The Answer!)

Look at `/Users/seoksoonjang/Desktop/hlvm/Makefile`:

```makefile
# HLVM embeds stdlib BEFORE compiling
build:
	@./src/embed-stdlib.ts        # ‚Üê KEY STEP!
	@deno compile \
		--allow-all \
		--output hlvm \
		src/hlvm-repl.ts
```

### What `embed-stdlib.ts` Does:
```
1. Reads all stdlib files
2. Converts them to TypeScript strings
3. Creates src/embedded-stdlib.ts
4. Binary imports embedded version (no file system needed!)
```

---

## üöÄ SOLUTION FOR HQL

### Step 1: Create HQL Embed Script

Create `/Users/seoksoonjang/Desktop/hlvm/src/hql/scripts/embed-packages.ts`:

```typescript
#!/usr/bin/env -S deno run --allow-read --allow-write

/**
 * Embeds HQL packages into TypeScript for binary compilation
 * Similar to HLVM's embed-stdlib.ts
 */

import { readTextFile, writeTextFile } from "../core/src/platform/platform.ts";
import { join } from "https://deno.land/std@0.208.0/path/mod.ts";

const PACKAGES_DIR = "./packages";
const OUTPUT_FILE = "./core/src/embedded-packages.ts";

async function embedPackages() {
  const packages = ["string", "math", "date", "fs", "test", "http"];

  let output = `// Auto-generated by embed-packages.ts\n`;
  output += `// DO NOT EDIT MANUALLY\n\n`;
  output += `export const EMBEDDED_PACKAGES: Record<string, string> = {\n`;

  for (const pkg of packages) {
    const pkgPath = join(PACKAGES_DIR, pkg, "mod.hql");
    try {
      const content = await readTextFile(pkgPath);
      const escaped = JSON.stringify(content);
      output += `  "@hql/${pkg}": ${escaped},\n`;
      console.log(`‚úÖ Embedded @hql/${pkg}`);
    } catch (e) {
      console.warn(`‚ö†Ô∏è  Skipped @hql/${pkg}: ${e.message}`);
    }
  }

  output += `};\n`;

  await writeTextFile(OUTPUT_FILE, output);
  console.log(`\nüì¶ Created ${OUTPUT_FILE}`);
}

if (import.meta.main) {
  await embedPackages();
}
```

### Step 2: Update Makefile

```makefile
build:
	@echo "üì¶ Embedding HQL packages..."
	@./scripts/embed-packages.ts
	@echo "üî® Building HQL binary..."
	@deno compile --allow-all --no-check --output $(BINARY) core/cli/cli.ts
	@echo "‚úÖ Done! Binary: ./$(BINARY)"
```

### Step 3: Update Package Resolution

Modify `mod.ts` to check embedded packages first:

```typescript
import { EMBEDDED_PACKAGES } from "./core/src/embedded-packages.ts";

// In rewriteImportStatement():
if (specifier.startsWith("@hql/")) {
  const packageName = specifier.replace("@hql/", "");

  // Check embedded first (for compiled binary)
  if (EMBEDDED_PACKAGES[`@hql/${packageName}`]) {
    // Return embedded content directly
    return EMBEDDED_PACKAGES[`@hql/${packageName}`];
  }

  // Fallback to file system (for development)
  specifier = platformResolve(HQL_MODULE_DIR, `packages/${packageName}/mod.hql`);
}
```

---

## üìä DISTRIBUTION COMPARISON

| Method | Status | Users Install With |
|--------|--------|-------------------|
| **Deno Install** | ‚úÖ Works | `deno install -A -n hql <url>` |
| **Local Binary** | üü° Partial | `make build && make install` |
| **Homebrew** | ‚è≥ Future | `brew install hql` |
| **NPM** | ‚è≥ Future | `npm install -g hql` |

---

## üéØ IMMEDIATE NEXT STEPS

1. ‚úÖ **Create `scripts/embed-packages.ts`** (copy from HLVM pattern)
2. ‚úÖ **Update Makefile** to run embedding first
3. ‚úÖ **Modify `mod.ts`** to check embedded packages
4. ‚úÖ **Test:** `make build && ./hql run test.hql`
5. ‚úÖ **Install:** `make install`

---

## üí° WHY THIS APPROACH?

**Deno compile limitation:**
- Can't read files from disk at runtime
- Must embed everything as TypeScript strings

**HLVM solution:**
- Pre-processes all resources
- Embeds as TypeScript constants
- Binary is self-contained

**Same applies to HQL!**

---

## üîÑ CURRENT WORKAROUND

Until fixed, users can use:

```bash
# Option 1: Deno direct (works perfectly)
deno run -A https://raw.githubusercontent.com/.../cli/run.ts hello.hql

# Option 2: Install with Deno
deno install -A -n hql https://raw.githubusercontent.com/.../cli/cli.ts
hql run hello.hql
```

---

## üìö References

- HLVM Makefile: `/Users/seoksoonjang/Desktop/hlvm/Makefile`
- HLVM embed script: `/Users/seoksoonjang/Desktop/hlvm/src/embed-stdlib.ts`
- HQL mod.ts: `/Users/seoksoonjang/Desktop/hlvm/src/hql/mod.ts` (line 846-850)

---

**Status:** Binary compiles ‚úÖ, but needs embedded packages for full functionality

**Next:** Implement embedding script (15 minutes of work!)
