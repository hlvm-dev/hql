# HQL VSCode Extension

Language support for HQL including syntax highlighting, autocompletion, and LSP features.

## Features

| Feature | Description | Shortcut |
|---------|-------------|----------|
| Syntax Highlighting | Keywords, functions, operators, strings | Automatic |
| Autocompletion | 156 items (snippets, keywords, builtins) | `Ctrl+Space` |
| Go to Definition | Jump to symbol definition (cross-file) | `F12` / `Ctrl+Click` |
| Document Symbols | Outline view of current file | `Cmd+Shift+O` |
| Workspace Symbols | Search symbols across project | `Cmd+T` |
| Find References | Find all usages of a symbol | `Shift+F12` |
| Hover | Show symbol info on hover | Mouse hover |
| Diagnostics | Parse errors in real-time | Automatic |

## Quick Start

```bash
cd vscode-hql
npm run release    # Build, package, and install
```

Then restart VSCode.

## Commands

```bash
npm run build           # Generate grammar + compile TypeScript
npm run generate-grammar # Regenerate syntax highlighting from HQL sources
npm run package         # Create .vsix package
npm run install-local   # Install to VSCode
npm run release         # All of the above
```

## Architecture: Single Source of Truth

Both syntax highlighting and autocompletion derive from HQL's core definitions:

```
src/common/known-identifiers.ts      → getAllKnownIdentifiers()
src/transpiler/keyword/primitives.ts → KERNEL_PRIMITIVES, ALL_OPERATOR_NAMES
        ↓                                       ↓
lsp/features/completion.ts          syntaxes/hql.tmLanguage.json
(imports dynamically)               (generated by scripts/generate-grammar.ts)
```

**When HQL adds new functions/macros**: Run `npm run release` to update.

## Project Structure

```
vscode-hql/
├── src/extension.ts              # VSCode extension entry (starts LSP)
├── syntaxes/hql.tmLanguage.json  # TextMate grammar (GENERATED)
├── scripts/generate-grammar.ts   # Generates grammar from HQL sources
├── language-configuration.json   # Brackets, comments config
└── package.json
```

## LSP Server

Embedded in HQL binary (`hql lsp --stdio`). Source in `/lsp/`:

```
lsp/
├── server.ts           # Main LSP server
├── analysis.ts         # Document parsing & symbols
├── features/           # Completion, hover, definition, etc.
└── workspace/          # Cross-file indexing
```

## Development

### Run in Debug Mode
1. Open `vscode-hql/` in VSCode
2. Press `F5` → launches Extension Development Host
3. Open any `.hql` file to test

### Test Features
```hql
(let x 42)
(fn greet [name] (str "Hello, " name))
(greet "World")
```
- **Completion**: Type `(` then `Ctrl+Space`
- **Hover**: Mouse over `greet`
- **Go to Definition**: `Ctrl+Click` on `greet`
- **Diagnostics**: Add `(let x` → red squiggly

## Troubleshooting

**No completion?** Wait 1-2 sec after opening file. Check Output → "HQL Language Server".

**Server not starting?** Test: `hql lsp --stdio` or `deno run --allow-all ../lsp/server.ts`
